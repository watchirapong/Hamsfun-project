# HamsterWorld User API Guide

This guide details the public API endpoints available for users and external applications integrating with HamsterWorldServer.

**Base URL:** `/api/v1` (except Auth routes)

---

## 1. Authentication

### 1.1 Discord Login
**URL:** `GET /auth/discord`
**Description:** Initiates the Discord OAuth2 login flow.

| Query Parameter | Type | Required | Description |
| :--- | :--- | :--- | :--- |
| `redirectUri` | String | No | The original redirect URI. |

### 1.2 Handover
**URL:** `GET /auth/handover`
**Description:** Receives the JWT token after Discord login.

### 1.3 Unity Login (Approval)
**URL:** `POST /auth/unity-login`
**Description:** Approves a pending Unity login request using a code generated by the Unity client.

**Header:** `Authorization: Bearer <TOKEN>` (User must be logged in on the web)

**Request Body:**
```json
{
  "code": "String (6-digit code from Unity)"
}
```

**Response:**
```json
{
  "message": "Unity login approved successfully"
}
```

---

## 2. User Profile

**Header:** `Authorization: Bearer <TOKEN>`

### 2.1 Get My Profile
**URL:** `GET /api/v1/users/me`
**Description:** Retrieves the current user's profile.

**Response Structure:**
```json
{
  "_id": "String (User ID)",
  "discordUsername": "String",
  "discordNickname": "String",
  "discordId": "String",
  "avatar": "String (URL)",
  "coins": "Number",
  "rank": {
    "currentTier": "String (e.g., 'Meteor I')",
    "points": "Number",
    "maxPoints": "Number (Points needed for next rank)",
    "nextRank": "String (Name of next rank) or null",
    "nextRankPoints": "Number (Max points of next rank) or null"
  },
  "badges": {
    "[BadgeCategory]": {
      "rank": "String (e.g., 'Bronze', 'Unranked')",
      "points": "Number",
      "maxPoints": "Number (Points needed for next badge rank)",
      "nextRank": "String or null",
      "nextRankPoints": "Number or null"
    }
  },
  "inventory": [],
  "activeQuests": [],
  "roles": [],
  "dailyShop": {},
  "partnerPet": {
    "itemId": "String (Template ID - ObjectId ref to Item)",
    "kind": "String ('Pet')",
    "nickname": "String",
    "level": "Number",
    "experience": "Number",
    "maxExperience": "Number",
    "currentStats": {
      "maxHealth": "Number",
      "attackDamage": "Number",
      "defense": "Number"
    },
    "iv": {
      "maxHealth": "Number (0-100)",
      "attackDamage": "Number (0-100)",
      "defense": "Number (0-100)"
    },
    "name": "String (Populated)",
    "icon": "String (Populated, URL)",
    "rarity": "String (Populated)"
  },
  "hamster": {
    "_id": "String (Hamster ID)",
    "hamsterRank": "String",
    "balls": "Number",
    "activeQuests": [],
    "completedQuests": [],
    "leaderOf": [
        { "_id": "TeamID", "name": "TeamName" }
    ],
    "questList": [
        {
            "_id": "QuestID",
            "title": "Quest Title",
            "icon": "Icon URL",
            "type": "Quest Type",
            "description": "Quest Description",
            "rewardPool": { "totalBalls": 100, "totalLeaderboardScore": 50 },
            "subQuests": [],
            "deadline": "Date"
        }
    ]
  }
}
```

### 2.2 Get User Profile by ID
**URL:** `GET /api/v1/users/:id`
**Description:** Retrieves a specific user's public profile.

> **Note:** Excludes sensitive fields: `discordId`, `email`, `inventory`, `activeQuests`, `roles`

### 2.3 Get My Inventory
**URL:** `GET /api/v1/users/me/inventory`
**Description:** Retrieves the current user's inventory.

### 2.4 Use Item
**URL:** `POST /api/v1/users/me/inventory/use`
**Description:** Consumes an item from the inventory.

**Request Body:**
```json
{
  "inventoryItemId": "String (Required) - The _id of the item inside the inventory array",
  "dojoId": "String (Optional) - Required if the item is a Ticket"
}
```

> [!NOTE]
> **Item Types & Effects:**
> - **NormalItem:** General item, decreases quantity by 1.
> - **TicketItem:** Status changes to 'Approving'. A TicketSubmission is created.
> - **QuestItem:** Grants the associated Quest to the user.
> - **GachaItem:** Opens and grants a random reward from potential items.
> - **ExpItem:** Feeds partner pet with experience points. **Requirement:** Must have an active `partnerPet`.
> - **PetItem:** **Swaps** the active pet. The current pet returns to inventory (saving progress), and the new pet becomes active (removed from inventory).
> - **PetStatItem:** Boosts partner pet stats.
> - **RobloxItem:** Can be redeemed in Roblox.
> - **EggItem:** Hatches a pet from the egg. Returns a new pet with random IVs (0-100) added to inventory. IVs use **bell curve distribution** where middle values (~50) are more common than extremes.

> [!TIP]
> **Pet IV Distribution:** IVs (0-100) use a bell curve distribution. Middle values (~40-60) are most common, while extreme values (0-10 or 90-100) are rare. This makes high-IV pets more valuable!

### 2.5 Generate Item Redeem Code
**URL:** `POST /api/v1/users/me/inventory/redeem-code`
**Description:** Generates a 10-character code for redeeming an item in Roblox.

> [!IMPORTANT]
> Only items with type `RobloxItem` can generate redeem codes.

**Request Body:**
```json
{
  "inventoryItemId": "String (Required) - The _id of the item inside the inventory array"
}
```

**Response:**
```json
{
  "success": true,
  "code": "ABC123XYZ0",
  "expiresIn": 300,
  "message": "Code generated. Use this in Roblox within 5 minutes.",
  "item": {
    "name": "Cool Sword",
    "robloxAssetId": "123456789",
    "amount": 1
  }
}
```

### 2.6 Get Active Quests
**URL:** `GET /api/v1/users/me/active-quests`
**Description:** Retrieves quests currently in progress.

### 2.7 Get Completed Quests
**URL:** `GET /api/v1/users/me/completed-quests`
**Description:** Retrieves a history of completed quests.

### 2.8 Rank Up
**URL:** `POST /api/v1/users/rank-up`
**Description:** Attempts to rank up the user if they have enough points.

**Response:**
```json
{
  "message": "Ranked up to Meteor II!",
  "newRank": "Meteor II",
  "maxPoints": 400,
  "points": 0
}
```

### 2.9 Get Timed Quests
**URL:** `GET /api/v1/users/me/timed-quests`
**Description:** Get current Daily/Weekly/Monthly quests with user progress.

---

## 3. Roblox Integration

### 3.1 Generate Roblox Verification Code
**URL:** `POST /api/v1/users/roblox/generate-code`
**Description:** Generates a 6-digit code for linking Roblox account.

**Response:**
```json
{
  "code": "123456",
  "expiresIn": 300,
  "message": "Use this code in the Roblox game or profile to verify your account."
}
```

### 3.2 Verify Roblox Code (Called by Roblox Game)
**URL:** `POST /api/v1/users/roblox/verify`
**Description:** Links a Roblox account to a website account.

**Request Body:**
```json
{
  "code": "123456",
  "robloxId": "123456789",
  "robloxUsername": "RobloxPlayer"
}
```

---

## 4. Quests
**Header:** `Authorization: Bearer <TOKEN>`

### 4.1 Get All Quests
**URL:** `GET /api/v1/quests`
**Description:** Retrieves all available quests.

### 4.2 Submit Quest
**URL:** `POST /api/v1/quests/:id/submit`
**Description:** Submit quest completion (Multipart/Form-Data).

**Request (Form Data):**
| Field | Type | Required | Description |
| :--- | :--- | :--- | :--- |
| `description` | String | No | Additional description |
| `subQuestId` | String | No | ID of sub-quest (if submitting sub-quest) |
| `imageProof` | File | No | Proof image |

---

## 5. Leaderboard

### 5.1 Get Leaderboard
**URL:** `GET /api/v1/leaderboard`
**Description:** Retrieves the global leaderboard.

**Response:**
```json
{
  "users": [
    {
      "discordUsername": "TopPlayer",
      "discordNickname": "TopNick",
      "leaderboardScore": 5000,
      "rank": { "currentTier": "Star I" }
    }
  ],
  "houses": [
    {
      "_id": "house123...",
      "name": "House of Valor",
      "score": 15000,
      "memberCount": 10
    }
  ]
}
```

---

## 6. Shop

### 6.1 Get Shop Products
**URL:** `GET /api/v1/shop/products`
**Description:** Get all available shop products.

---

## 7. Real-Time Updates (WebSocket)

The server supports real-time updates via Socket.IO.

### 7.1 Connection

- **URL:** `http://<SERVER_IP>:5000`
- **Auth:** JWT Token (Same as API)
    - Pass via `auth.token` object or `Authorization` header.

**Client Example (JS):**
```javascript
import { io } from "socket.io-client";

const socket = io("http://localhost:5000", {
  auth: {
    token: "YOUR_JWT_TOKEN"
  }
});

socket.on("connect", () => {
  console.log("Connected:", socket.id);
});
```

### 7.2 Events (Receive)

#### `quest_updated`
Emitted when a quest submission is reviewed (Approved/Rejected).

**Payload:**
```json
{
  "type": "Quest",
  "status": "Approved",
  "questId": "65672...",
  "submissionId": "65673...",
  "reason": "Feedback message (if rejected)"
}
```

#### `unity_login_code`
Emitted to the Unity client after requesting a login.

**Payload:**
```json
{
  "code": "123456",
  "expiresIn": 300
}
```

#### `unity_login_success`
Emitted to the Unity client after the user approves the login on the web.

**Payload:**
```json
{
  "token": "JWT_TOKEN",
  "user": {
    "_id": "...",
    "username": "...",
    "avatar": "..."
  }
}
```

### 7.3 Client Actions (Emit)

#### `request_unity_login`
**Description:** Request a temporary login code for Unity authentication (Server-Generated).
**Payload:** `null`

#### `register_unity_code`
**Description:** Register a client-generated code (UUID) for Unity authentication.
**Payload:** `String` (The UUID code)